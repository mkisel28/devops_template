#!/bin/bash

# ===========================================
# –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–• –ë–ï–ö–ê–ü–û–í
# ===========================================

set -euo pipefail

# –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
source /app/scripts/lib/logger.sh
source /app/scripts/lib/config.sh
source /app/scripts/lib/telegram.sh

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
init_logger
load_config

log_info "‚è∞ –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –±–µ–∫–∞–ø–æ–≤ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_NAME"

# –°–æ–∑–¥–∞–Ω–∏–µ crontab —Ñ–∞–π–ª–∞
create_crontab() {
    local crontab_file="/tmp/backup_crontab"
    local backup_schedule="${BACKUP_SCHEDULE:-0 2 * * *}"
    
    cat > "$crontab_file" << EOF
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–µ–∫–∞–ø –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ $PROJECT_NAME
$backup_schedule /app/scripts/backup.sh >> /app/logs/cron.log 2>&1

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 1:00)
0 1 * * 0 /app/scripts/test-connection.sh >> /app/logs/cron.log 2>&1

# –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤ (1 —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 3:00)
0 3 1 * * /app/scripts/cleanup.sh >> /app/logs/cron.log 2>&1
EOF
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ crontab
    crontab "$crontab_file"
    rm -f "$crontab_file"
    
    log_success "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º: $backup_schedule"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
check_configuration() {
    log_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    if [ "${BACKUP_ENABLED:-false}" != "true" ]; then
        log_error "‚ùå –ë–µ–∫–∞–ø—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (BACKUP_ENABLED=false)"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if [ -z "${BACKUP_SCHEDULE:-}" ]; then
        log_error "‚ùå –ù–µ –∑–∞–¥–∞–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–µ–∫–∞–ø–æ–≤ (BACKUP_SCHEDULE)"
        exit 1
    fi
    
    log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤–∞–ª–∏–¥–Ω–∞"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
test_components() {
    log_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
    local required_scripts=("backup.sh" "test-connection.sh" "cleanup.sh")
    
    for script in "${required_scripts[@]}"; do
        if [ ! -x "/app/scripts/$script" ]; then
            log_error "‚ùå –°–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π: $script"
            exit 1
        fi
    done
    
    log_success "–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–µ–∫–∞–ø–∞
initial_backup_test() {
    log_step "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
    
    # –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    if /app/scripts/test-connection.sh; then
        log_success "–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ"
    else
        log_error "‚ùå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        log_warn "‚ö†Ô∏è  –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–µ–∫–∞–ø—ã –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
    fi
    
    # –ü—Ä–æ–±–Ω—ã–π –±–µ–∫–∞–ø –≤ dry-run —Ä–µ–∂–∏–º–µ
    log_info "üîç –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–Ω–æ–≥–æ –±–µ–∫–∞–ø–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."
    if DRY_RUN=true /app/scripts/backup.sh --dry-run; then
        log_success "–ü—Ä–æ–±–Ω—ã–π –±–µ–∫–∞–ø –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ"
    else
        log_error "‚ùå –ü—Ä–æ–±–Ω—ã–π –±–µ–∫–∞–ø –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        exit 1
    fi
}

# –ó–∞–ø—É—Å–∫ cron daemon
start_cron_daemon() {
    log_step "–ó–∞–ø—É—Å–∫ cron daemon..."
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    mkdir -p /tmp/cron
    
    # –ó–∞–ø—É—Å–∫ crond –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (Alpine Linux)
    crond -f -l 0 -L /app/logs/cron.log &
    local cron_pid=$!
    
    log_success "Cron daemon –∑–∞–ø—É—â–µ–Ω (PID: $cron_pid)"
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    notify_backup_start "$PROJECT_NAME" "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω"
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
    wait $cron_pid
}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
cleanup_on_exit() {
    local exit_code=$?
    
    log_info "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞..."
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ cron
    pkill crond 2>/dev/null || true
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
    if [ "${TELEGRAM_ENABLED:-false}" = "true" ]; then
        send_telegram_message "üõë <b>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>

üì¶ <b>–ü—Ä–æ–µ–∫—Ç:</b> $PROJECT_NAME
‚è∞ <b>–í—Ä–µ–º—è:</b> $(date '+%Y-%m-%d %H:%M:%S')
üñ•Ô∏è <b>–°–µ—Ä–≤–µ—Ä:</b> $(hostname)"
    fi
    
    exit $exit_code
}

trap cleanup_on_exit SIGTERM SIGINT

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log_info "‚è∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±–µ–∫–∞–ø–æ–≤"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    show_config
    
    echo
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    check_configuration
    test_components
    initial_backup_test
    
    echo
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    create_crontab
    
    log_info "üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
    log_info "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–µ–∫–∞–ø–æ–≤: ${BACKUP_SCHEDULE}"
    log_info "üìã –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤: /app/logs/"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è cron
    log_info "üìù –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è cron:"
    crontab -l | grep -v '^#' | while read -r line; do
        [ -n "$line" ] && log_info "   $line"
    done
    
    echo
    start_cron_daemon
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@"
